---
title: "Getting Started with Data Bars"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, include=FALSE}
library(reactablefmtr)
library(viridis)
library(dplyr)
library(stringr)
library(purrr)
library(nflfastR)
```


```{r, echo=FALSE}
index <- data.frame(
 `Argument` = c("data",
               "fill_color",
               "fill_color_ref",
               "fill_opacity",
               "fill_gradient",
               "background",
               "max_value",
               "min_value",
               "align_bars",
               "bar_height",
               "text_position",
               "force_outside",
               "text_color",
               "text_size",
               "brighten_text",
               "brighten_text_color",
               "bold_text",
               "number_fmt",
               "border_width",
               "border_style",
               "border_color",
               "icon",
               "icon_ref",
               "icon_size",
               "icon_color",
               "icon_color_ref",
               "img",
               "img_ref",
               "img_height",
               "img_width",
               "animation"),
 `Description` = c("name of dataset",
                   "a single color or a vector of fill_color for the fill of the data bars",
                   "the name of a column containing color assignments for the filled bars",
                   "a value between 0 and 1 that adjusts the opacity in fill_color",
                   "convert the fill color to a gradient color scheme (more than one color must be provided in `fill_color`",
                   "the color for the background of the data bars",
                   "a value to use as the maximum value for the width of the filled bars",
                   "a value to use as the minimum value for the width of the filled bars",
                   "align filled bars from left-to-right or right-to-left",
                   "numeric height of the data bars",
                   "where to display the text labels in relation to the filled bars",
                   "force a range of values to display their text labels on the outside-end of the filled bars",
                   "the color of the text labels",
                   "numeric value representing the size of the text labels for the values",
                   "automatically assign color to text labels based on filled color when the text is placed inside the filled bars",
                   "color of the text labels placed within a dark-colored filled bar",
                   "display the text labels in bold",
                   "format numbers using formats from the scales package",
                   "the width of the border around the filled data bars",
                   "the style of the border around the filled data bars",
                   "the color of the border around the filled data bars",
                   "assign an icon label from the Font Awesome library (via shiny)",
                   "the name of a column containing icon assignments for the values",
                   "a value representing the size of the icon",
                   "the color for the icon",
                   "the name of a column containing icon color assignments",
                   "assign an image label via a valid URL",
                   "the name of a column containing image assignments for the values",
                   "a value for the height of the image",
                   "a value for the width of the image",
                   "control the duration and timing function of the animation when sorting/updating values shown on a page"
                   )
)

```

## Index 

```{r, echo=FALSE}
reactable(index,
          columns = list(
            `Argument` = colDef(minWidth = 70),
            `Description` = colDef(minWidth = 200)
          ))
```

## Position Text Labels

The position of where the text labels are displayed relative to the filled data bars can be controlled with `text_position`. The text labels can be positioned in multiple locations within and outside of the filled data bars, including: "inside-end", "outside-end", "inside-base", "outside-base", "center", or "none".

### Default label position

By default, the text labels are positioned on the "inside-end" of the filled bars:

```{r}
data <- data.frame(
  Group = c("Red Group 1","Red Group 2","Red Group 3","Red Group 4","Red Group 5",
            "Blue Group 1","Blue Group 2","Blue Group 3","Blue Group 4","Blue Group 5",
            "Green Group 1","Green Group 2","Green Group 3","Green Group 4","Green Group 5"),
  Value1 = c(27, 82, 44, 68, 78, 
           74, 66, 33, 23, 11, 
           50, 55, 40, 71, 60),
  Value2 = c(33, 17, 87, 54, 37,
           70, 72, 61, 48, 77,
           21, 39, 60, 55, 71)
)

reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "inside-end labels",
      cell = data_bars(data)
      ),
    Value2 = colDef(show = FALSE)
  )
)
```

### Labels Outside

Change the position of the text labels from the "inside-end" of the filled data bars to the outside of the filled data bars with "outside-end" and "outside-base" within `text_position`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "outside-base labels",
      cell = data_bars(data, text_position = "outside-base")
      ),
    Value2 = colDef(
      name = "outside-end labels",
      cell = data_bars(data, text_position = "outside-end")
      )
  )
)
```

### Labels Inside

In addition to the default "inside-end" labels, labels can also be positioned within the filled data bars using "inside-base", and "center":

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "inside-base labels",
      cell = data_bars(data, text_position = "inside-base")
      ),
    Value2 = colDef(
      name = "centered labels",
      cell = data_bars(data, text_position = "center")
      )
  )
)
```

### Hide Labels

Hide text labels by setting `text_position` to "none":

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "no labels",
      cell = data_bars(data, text_position = "none")
      ),
    Value2 = colDef(
      name = "no labels",
      cell = data_bars(data, text_position = "none")
      )
  )
)
```

### Combination

Text labels that are placed anywhere within the data bars (inside-end, inside-base, or center), can be combined with outside-end text labels by specifying a range of values to show on the outside-end using `force_outside`. This can be useful when the length of the filled data bars is too short to the text labels on the inside of the filled bars:

```{r}
df <- data.frame(
  Group = c("Red Group 1","Red Group 2","Red Group 3","Red Group 4","Red Group 5",
            "Green Group 1","Green Group 2","Green Group 3","Green Group 4","Green Group 5"),
  Value1 = c(1, 2, 4, 6, 60, 18, 5, 25, 55, 50),
  Value2 = c(1, 3, 5, 15, 120, 37, 10, 48, 80, 54)
)

reactable(
  df,
  defaultSortOrder = "desc",
  defaultSorted = "Value2",
  columns = list(
    Value1 = colDef(
      name = "Values between 0 and 6 forced to outside-end labels",
      cell = data_bars(df, force_outside = c(0,6))
      ),
    Value2 = colDef(
      name = "Values between 0 and 15 forced to outside-end labels",
      cell = data_bars(df, force_outside = c(0,15))
      )
  )
)
```

## Colors

There are multiple options available to change the color of the data bars. 

### Fill color

The default fill color is #67a9cf, but can be changed to any color with `fill_color`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Red fill color",
      cell = data_bars(data, fill_color = "red")
      ),
    Value2 = colDef(
      name = "Black fill color",
      cell = data_bars(data, fill_color = "black")
      )
  )
)
```

### Conditional coloring

If more than one color is provided within `fill_color`, the colors will be applied conditionally to the values within their respective columns from low values to high values:

```{r}
library(viridis)
reactable(
  data,
  pagination = FALSE,
  defaultColDef = colDef(
    name = "Multiple fill colors",
    cell = data_bars(data, fill_color = viridis::viridis(8))
  )
)
```

### Gradient colors

If multiple colors are provided within `fill_color`, the colors can be converted from a conditional color scheme to a left-to-right gradient color scheme within each bar by setting `fill_gradient` to TRUE:

```{r}
reactable(
  data,
  pagination = FALSE,
  defaultColDef = colDef(
    name = "Gradient fill colors",
    cell = data_bars(data, fill_gradient = TRUE, brighten_text = FALSE, fill_color = viridis::viridis(8))
  )
)
```
<i>Note: You may need to adjust the brighten text arguments by either turning it off like in the example above, or by changing the color within `brighten_text_color` in order for all of the text labels to be visible when using `fill_gradient`.</i>

### Opacity

The opacity of the filled data bar color can be adjusted by providing a value from 0 to 1 (0 being fully transparent and 1 being fully opaque) within `fill_opacity`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Opacity of 0.2",
      cell = data_bars(data, fill_opacity = 0.2, fill_gradient = TRUE, fill_color = viridis::viridis(5), brighten_text = FALSE)
      ),
    Value2 = colDef(
      name = "Opacity of 0.6",
      cell = data_bars(data, fill_opacity = 0.6, fill_gradient = TRUE, fill_color = viridis::viridis(5), brighten_text = FALSE)
      )
  )
)
```


### Assign colors to groups

You can conditionally assign colors to groups of data with the `fill_color_ref` argument. For example, if we wanted to assign a red color to the Red group, a blue color to the Blue group, and a green color to the Green group, we could do so by first creating a conditional column containing the color assignments for each group and then referencing the name of that column within `fill_color_ref`:

```{r}
data %>%
  mutate(color_pal = case_when(
    str_detect(Group, "Red") ~ "#FF3B28",
    str_detect(Group, "Blue") ~ "#006FEF",
    str_detect(Group, "Green") ~ "#3ABC0E",
    TRUE ~ "darkgrey"
  )) %>%
reactable(.,
  pagination = FALSE,
  defaultColDef = colDef(
    name = "Colors assigned by group",
    cell = data_bars(., fill_color_ref = "color_pal")
  ),
  columns = list(color_pal = colDef(show = FALSE) ## hide the color_pal column
  )
) 
```

Or you can conditionally assign colors based on values:

```{r}
data %>%
  mutate(color_pal = case_when(
    Value1 >= 70 ~ "#FF3B28",
    TRUE ~ "darkgrey"
  )) %>%
  select(-Value2) %>% 
reactable(.,
  pagination = FALSE,
  defaultSorted = "Value1",
  defaultSortOrder = "desc",
  defaultColDef = colDef(
    name = "Values >70 colored red",
    cell = data_bars(., fill_color_ref = "color_pal")
  ),
  columns = list(color_pal = colDef(show = FALSE)
  )
) 
```

### Background color

By default, the background color (the area between the value of the row and the maximum value in the column) is transparent. However, it can be changed to any color within the `background` argument:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Light-grey background",
      cell = data_bars(data, background = "lightgrey")
      ),
    Value2 = colDef(
      name = "Orange background",
      cell = data_bars(data, background = "orange")
      )
  )
)
```

### Colors for positive and negative values

If displaying a column containing both positive and negative values, the first color provided within `fill_color` will be used to fill the negative bars while the second color provided will be used to fill the positive bars:

```{r}
data %>% 
  mutate(Change = Value1 - Value2) %>% 
  select(Group, Change) %>% 
reactable(.,
  defaultSorted = "Change",
  pagination = FALSE,
  columns = list(
    Change = colDef(
      name = "Positive and negative values",
      cell = data_bars(., fill_color = c("lightblue","orange")))
  )
)
```

If more than two colors are provided, the bars will be conditionally filled from low values to high values: 

```{r}
data %>% 
  mutate(Change = Value1 - Value2) %>% 
  select(Group, Change) %>% 
reactable(.,
  defaultSorted = "Change",
  pagination = FALSE,
  columns = list(
    Change = colDef(
      name = "Multiple fill colors for positive and negative values",
      cell = data_bars(., fill_color = c("#6f4683","#886593","#e23e64","#e69d25")))
  )
)
```


## Text Label Options

The appearance of the text labels can be altered with a number of different formatting options. 

### Text color

The default text color of the labels is black, but can be changed with `text_color`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Gold text color",
      cell = data_bars(data, text_color = "gold")
      ),
    Value2 = colDef(
      name = "Purple text color",
      cell = data_bars(data, text_color = "purple")
      )
  )
)
```

When dark color palettes are used and text are placed inside the filled bars, the text will automatically show as white in dark-colored bars and black in light-colored bars in order to improve visibility. If you prefer to use another color other than the default white, the color can be changed with `brighten_text_color`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "automatic white text color",
      cell = data_bars(data, fill_color = "#222222")
      ),
    Value2 = colDef(
      name = "skyblue brighten_text_color",
      cell = data_bars(data, fill_color = "#222222", brighten_text_color = "skyblue")
      )
  )
)
```

<i>Note: This feature can be turned off by setting `brighten_text` = FALSE.</i>

### Size of text labels

The default size of the text labels is 16, but can be changed within `text_size`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "small text size",
      cell = data_bars(data, text_size = 10)
      ),
    Value2 = colDef(
      name = "large text size",
      cell = data_bars(data, text_size = 40)
      )
  )
)
```

### Bold text labels

Make text labels stand out more by setting `bold_text` to TRUE:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "normal text",
      cell = data_bars(data, text_size = 26)
      ),
    Value2 = colDef(
      name = "bold text",
      cell = data_bars(data, text_size = 26, bold_text = TRUE)
      )
  )
)
```

### Formatting values

Numbers can be formatted by calling formatters from the {scales} package, similar to how one would do within {ggplot2}:

```{r}
data_pct <- data %>% 
  mutate(Percentage = Value1/100) %>% 
  select(c(Group, Percentage))

reactable(
  data_pct,
  pagination = FALSE,
  columns = list(
    Percentage = colDef(
      name = "Percent format",
      cell = data_bars(data_pct, number_fmt = scales::percent))
  )
)
```


## Direction of Data Bars

By default, the filled bars are aligned from left-to-right, but can be aligned from right-to-left by setting `align_bars = "right"`:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Right-aligned bars",
      cell = data_bars(data, align_bars = "right")
      ),
    Value2 = colDef(
      name = "Left-aligned bars",
      cell = data_bars(data, align_bars = "left")
      )
  )
)
```

## Height of Data Bars

The default height of the data bars is set to 19px but can be adjusted within `bar_height`.

To increase the height of the bars, provide a numeric value greater than 19, and to decrease the height of the bars, provide a value less than 19:

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Thick bars",
      cell = data_bars(data, bar_height = 40)
      ),
    Value2 = colDef(
      name = "Thin bars",
      cell = data_bars(data, bar_height = 4, text_position = "outside-end")
      )
  )
)
```

## Borders

The borders around the filled data bars can be controlled via three options: `border_style`, `border_color`, and `border_width`.

### Border Style

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Dotted border",
      cell = data_bars(data, border_style = "dotted", text_position = "outside-end")
      ),
    Value2 = colDef(
      name = "Outset border",
      cell = data_bars(data, border_style = "outset", text_position = "outside-end")
      )
  )
)
```

### Border Color

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Red dotted border",
      cell = data_bars(data, border_color = "red", border_style = "dotted", text_position = "outside-end")
      ),
    Value2 = colDef(
      name = "Purple outset border",
      cell = data_bars(data, border_color = "purple", border_style = "outset", text_position = "outside-end")
      )
  )
)
```


### Border Width

```{r}
reactable(
  data,
  pagination = FALSE,
  columns = list(
    Value1 = colDef(
      name = "Small red dotted border",
      cell = data_bars(data, border_width = "2px", border_color = "red", border_style = "dotted", text_position = "outside-end")
      ),
    Value2 = colDef(
      name = "Large purple outset border",
      cell = data_bars(data, border_width = "5mm", border_color = "purple", border_style = "outset", text_position = "outside-end")
      )
  )
)
```


## Maximum Bar Width

By default, the width of the filled data bars is equal to the maximum value within that particular column. In most cases, this is what we want to display, but sometimes it's better to extend the range. For example, in the percentages below, if we want to extend the width to show the values out of 100%, we could do so by setting the `max_value` to 1:

```{r}
data_pct %>% 
  mutate(Percentage2 = Percentage) %>% 
reactable(
  .,
  pagination = FALSE,
  defaultSorted = "Percentage",
  defaultSortOrder = "desc",
  columns = list(
    Percentage = colDef(
      name = "Maximum bar width of 100%",
      cell = data_bars(., max_value = 1, fill_color = viridis(5), background = "lightgrey", number_fmt = scales::percent)
      ),
    Percentage2 = colDef(
      name = "Maximum bar width of 200%",
      cell = data_bars(., max_value = 2, fill_color = viridis(5), background = "lightgrey", number_fmt = scales::percent)
      )    
  )
)
```

Now when you look at the 82% value above, there is 18% empty space filled by the background showing that the value is out of 100% and not 82%.


## Add Icons to Bars

Now within the `data_bars()` formatter, you can directly add icons to your tables!

First let's start with a dataset that shows fake data from some of the leading social media websites. We will later use the names of the sites within the Logo column to apply the icons from the [Font Awesome](https://fontawesome.com/icons) icon library. Please note that the names of the sites are all lower-case to match the icon names within Font Awesome.

```{r}
data <- data.frame(
  Company = c("facebook", "twitter", "linkedin", "reddit", "youtube", "instagram", "pinterest", "snapchat"),
  Primary = c("#4267B2", "#1DA1F2", "#0E76A8", "#FF4500", "#FF0000", "#833AB4", "#E60023", "#FFFC00"),
  Values = c(75, 120, 90, 100, 80, 70, 60, 40)
)

reactable(
  data,
  defaultSorted = "Values",
  defaultSortOrder = "desc",
  columns = list(
    Primary = colDef(show = FALSE),
    Values = colDef(
      name = "Icons",
      cell = data_bars(data, icon_ref = "Company", fill_color = "black", fill_opacity = 0.8))
  )
)
```

By default, the color of the icon is inherited from the color of the filled data bar, but they can be changed either through `icon_color` or with `icon_color_ref` which we will be using below in order to apply each company's primary color to icons:

```{r}
reactable(
  data,
  defaultSorted = "Values",
  defaultSortOrder = "desc",
  columns = list(
    Primary = colDef(show = FALSE),
    Values = colDef(
      name = "Icons with colors assigned",
      cell = data_bars(data, icon_ref = "Company", icon_color_ref = "Primary", fill_color = "black", fill_opacity = 0.8))
  )
)
```

An alternative would be to use `fill_color_ref` instead, which applies each company's primary color to the fill of the data bars and then the icons inherit that color as well:

```{r}
reactable(
  data,
  defaultSorted = "Values",
  defaultSortOrder = "desc",
  columns = list(
    Primary = colDef(show = FALSE),
    Values = colDef(
      name = "Icons and bars with colors assigned",
      cell = data_bars(data, icon_ref = "Company", fill_color_ref = "Primary"))
  )
)
```

The size of the icons can also be adjusted with `icon_size`:

```{r}
reactable(
  data,
  defaultSorted = "Values",
  defaultSortOrder = "desc",
  columns = list(
    Primary = colDef(show = FALSE),
    Values = colDef(
      name = "Large icons",
      cell = data_bars(data, icon_ref = "Company", icon_size = 36, fill_color_ref = "Primary")
    )
  )
) 
```



## Add Images to Bars

Similarly, you can now assign images to your data bars!

First let's load the dataset from [nflfastR](https://www.nflfastr.com/articles/beginners_guide.html) that was used in the [Embed Images](https://kcuilla.github.io/reactablefmtr/articles/embed_img.html) example (this dataset is limited to just the 2018-2019 seasons):

```{r}
## load multiple seasons
seasons <- 2018:2019
pbp <- map_df(seasons, function(x) {
  readRDS(url(
    paste0(
      "https://raw.githubusercontent.com/guga31bb/nflfastR-data/master/data/play_by_play_",
      x,
      ".rds"
    )
  ))
})

## figures with QB stats
qbs <- pbp %>%
  filter(week <= 17,!is.na(epa)) %>%
  group_by(id, name) %>%
  summarize(
    epa = mean(qb_epa),
    cpoe = mean(cpoe, na.rm = T),
    n_dropbacks = sum(pass),
    n_plays = n(),
    team = last(posteam)
  ) %>%
  ungroup() %>%
  filter(n_dropbacks > 100 & n_plays > 1000)

## join team logos to dataset
qbs <- qbs %>%
  left_join(teams_colors_logos, by = c('team' = 'team_abbr')) %>% 
  select(name, team_logo_espn, team_color, cpoe, epa)
```

The URL's for the team logos contained within the team_logo_espn column can be referenced using `img_ref` to overlay on top of the data bars. The images can also be re-sized using `img_height` and `img_width`. The default image size is 20px by 20px. 

```{r}
reactable(
  qbs,
  defaultPageSize = 20,
  columns = list(
    team_logo_espn = colDef(show = FALSE), ## hide column containing team logos
    team_color = colDef(show = FALSE), ## hide column containing team colors
    name = colDef(maxWidth = 120),
    cpoe = colDef(
      cell = data_bars(qbs, fill_color_ref = "team_color", fill_opacity = 0.3, brighten_text = FALSE, number_fmt = scales::percent, img_ref = "team_logo_espn", img_height = 30, img_width = 30)
    ),
    epa = colDef(
      cell = data_bars(qbs, fill_color_ref = "team_color", fill_opacity = 0.3, brighten_text = FALSE, number_fmt = scales::number_format(accuracy = 0.01), img_ref = "team_logo_espn", img_height = 30, img_width = 30)
    )
  )
)
```

